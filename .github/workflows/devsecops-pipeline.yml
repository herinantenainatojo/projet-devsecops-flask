name: DevSecOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Scan quotidien Ã  2h du matin
    - cron: '0 2 * * *'

# ðŸ›¡ï¸ Permissions nÃ©cessaires pour CodeQL, Trivy et rapports de sÃ©curitÃ©
permissions:
  contents: read              # lecture du dÃ©pÃ´t
  security-events: write      # autorise lâ€™Ã©criture des rÃ©sultats dâ€™analyse de sÃ©curitÃ©
  actions: read               # permet dâ€™utiliser les actions GitHub
  packages: read              # autorise la lecture dâ€™images/dÃ©pendances GitHub Packages (utile pour Trivy)
  checks: write               # (optionnel) autorise la publication de rapports dans les checks GitHub


jobs:
  # =====================================================
  # JOB 1 : Tests Unitaires
  # =====================================================
  tests:
    name: Tests Unitaires
    runs-on: ubuntu-latest

    steps:
    - name: Checkout du code
      uses: actions/checkout@v4

    - name: Configuration Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: ExÃ©cution des tests
      run: |
        # CrÃ©er un dossier tests s'il n'existe pas
        mkdir -p tests
        # ExÃ©cuter pytest (skip si pas de tests pour l'instant)
        pytest --cov=app --cov-report=xml --cov-report=html || echo "Pas de tests dÃ©finis"

    - name: Upload rapport de couverture
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: htmlcov/

  # =====================================================
  # JOB 2 : Analyse SAST avec Bandit
  # =====================================================
  sast-bandit:
    name: SAST - Bandit
    runs-on: ubuntu-latest
    needs: tests

    steps:
    - name: Checkout du code
      uses: actions/checkout@v4

    - name: Configuration Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Installation de Bandit
      run: pip install bandit[toml]

    - name: Analyse Bandit
      run: |
        bandit -r . -f json -o bandit-report.json --exclude ./venv || true
        bandit -r . -f html -o bandit-report.html --exclude ./venv || true

    - name: Upload rapport Bandit
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-report
        path: |
          bandit-report.json
          bandit-report.html

  # =====================================================
  # JOB 3 : Scan des DÃ©pendances (SCA)
  # =====================================================
  sca-dependencies:
    name: SCA - Scan des DÃ©pendances
    runs-on: ubuntu-latest
    needs: tests

    steps:
    - name: Checkout du code
      uses: actions/checkout@v4

    - name: Configuration Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Installation de Safety
      run: pip install safety

    - name: Scan Safety
      run: |
        safety check --json --output safety-report.json || true
        safety check --output safety-report.txt || true

    - name: OWASP Dependency-Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'projet-devsecops-flask'
        path: '.'
        format: 'HTML'
        args: >
          --enableRetired
          --enableExperimental

    - name: Upload rapports SCA
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sca-reports
        path: |
          safety-report.json
          safety-report.txt
          reports/

  # =====================================================
  # JOB 4 : Scan de Secrets
  # =====================================================
  secret-scanning:
    name: Scan de Secrets
    runs-on: ubuntu-latest
    needs: tests

    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Historique complet pour TruffleHog

    - name: TruffleHog Secret Scanning
      uses: trufflesecurity/trufflehog@main
      with:
        extra_args: --only-verified

  # =====================================================
  # JOB 5 : Build Docker Image
  # =====================================================
  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [sast-bandit, sca-dependencies]

    steps:
    - name: Checkout du code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker Image
      run: |
        docker build -t flask-app:${{ github.sha }} -f Dockerfile .

    - name: Save Docker Image
      run: |
        docker save flask-app:${{ github.sha }} -o flask-app.tar

    - name: Upload Docker Image
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: flask-app.tar

  # =====================================================
  # JOB 6 : Scan Docker avec Trivy
  # =====================================================
  docker-scan:
    name: Scan Docker - Trivy
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
    - name: Checkout du code
      uses: actions/checkout@v4

    - name: Download Docker Image
      uses: actions/download-artifact@v4
      with:
        name: docker-image

    - name: Load Docker Image
      run: docker load -i flask-app.tar

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'flask-app:${{ github.sha }}'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Trivy scan en HTML
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'flask-app:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/html.tpl'
        output: 'trivy-report.html'

    - name: Upload Trivy results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: trivy-report
        path: |
          trivy-results.sarif
          trivy-report.html

    - name: Upload to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # =====================================================
  # JOB 7 : Rapport de SynthÃ¨se
  # =====================================================
  security-report:
    name: GÃ©nÃ©ration Rapport de SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: [sast-bandit, sca-dependencies, secret-scanning, docker-scan]
    if: always()

    steps:
    - name: Checkout du code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: GÃ©nÃ©ration du rapport de synthÃ¨se
      run: |
        echo "# ðŸ”’ Rapport de SÃ©curitÃ© DevSecOps" > security-summary.md
        echo "" >> security-summary.md
        echo "**Date:** $(date)" >> security-summary.md
        echo "**Commit:** ${{ github.sha }}" >> security-summary.md
        echo "" >> security-summary.md
        echo "## âœ… Jobs exÃ©cutÃ©s" >> security-summary.md
        echo "- Tests Unitaires" >> security-summary.md
        echo "- SAST (Bandit)" >> security-summary.md
        echo "- SCA (Safety + OWASP)" >> security-summary.md
        echo "- Secret Scanning (TruffleHog)" >> security-summary.md
        echo "- Docker Build & Scan (Trivy)" >> security-summary.md

    - name: Upload rapport final
      uses: actions/upload-artifact@v4
      with:
        name: security-summary
        path: security-summary.md
